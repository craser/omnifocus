#!/usr/bin/env osascript -l JavaScript
"use strict";const t=[new e("sunday",/\b(sun|sunday)\b/i,0),new e("monday",/\b(mon|monday)\b/i,1),new e("tuesday",/\b(tues|tuesday)\b/i,2),new e("wednesday",/\b(wed|wednesday)\b/i,3),new e("thursday",/\b(thr|thrs|thurs|thursday)\b/i,4),new e("friday",/\b(fri|friday)\b/i,5),new e("saturday",/\b(sat|saturday)\b/i,6)];function e(t,e,n){this.name=t,this.pattern=e,this.index=n}function n(){return new Date}function r(e){if(/\bnow\b/i.test(e))return r=new Date;if(/today/i.test(e))return r=new Date;if(/tomorrow/i.test(e))return(r=new Date).setDate(r.getDate()+1),r;if(/tmw/i.test(e))return(r=new Date).setDate(r.getDate()+1),r;if(function(e){try{var n=t.find((function(t){return t.pattern.test(e)}));return!!n}catch(t){return!1}}(e)){var r=function(e){var n=new Date;return t.forEach((function(t){if(t.pattern.test(e)){var r=(new Date).getDay(),a=(t.index+7-r)%7;n.setDate(n.getDate()+a)}})),n}(e);return r}if(/(\d{1,2})\/(\d{1,2})(\/(\d{2,4}))?/.test(e)){var a=e.match(/(\d{1,2})\/(\d{1,2})(\/(\d{2,4}))?/),o=a[1],s=a[2],i=a[4]||(new Date).getFullYear();return(r=n()).setMonth(parseInt(o)-1),r.setDate(s),r.setFullYear(i),r}}function a(t,e){let a=r(e);return a&&((t=t||n()).setYear(a.getFullYear()),t.setMonth(a.getMonth()),t.setDate(a.getDate())),t}function o(t,e){let r=t||n();if(/\bnow\b/i.test(e)){var a=new Date;return r.setYear(a.getFullYear()),r.setMonth(a.getMonth()),r.setDate(a.getDate()),r}if(/next/i.test(e))return r.setDate((new Date).getDate()),r;if(/[+-]?\d+\s?days?/i.test(e)){var o=e.match(/([+-]?\d+)\s?days?/i),s=parseInt(o[1]);return r.setDate(r.getDate()+s),r}if(/[+-]?\d+\s?weeks?/i.test(e)){o=e.match(/([+-]?\d+)\s?weeks?/i),s=7*parseInt(o[1]);return r.setDate(r.getDate()+s),r}if(/[+-]?\d+\s?months?/i.test(e)){o=e.match(/([+-]?\d+)\s?months?/i);var i=parseInt(o[1]);return r.setMonth(r.getMonth()+i),r}if(/[+-]?\d+\s?years?/i.test(e)){o=e.match(/([+-]?\d+)\s?years?/i);var c=parseInt(o[1]);return r.setYear(r.getFullYear()+c),r}return t}function s(t){if(/\d+\s?hrs?/i.test(t)){var e=t.match(/(\d+)\s?hrs?/i),n=parseInt(e[1]);return(r=new Date).setHours(r.getHours()+n),{hours:r.getHours(),minutes:r.getMinutes(),seconds:0}}if(/\d+\s?mins?/i.test(t)){e=t.match(/(\d+)\s?mins?/i);var r,a=parseInt(e[1]);return(r=new Date).setMinutes(r.getMinutes()+a),{hours:r.getHours(),minutes:r.getMinutes(),seconds:0}}if(/(\d{1,2})(:(\d\d))?\s*(am|pm)/i.test(t)){e=t.match(/(\d{1,2})(:(\d\d))?\s*(am|pm)/i);var o=/pm/i.test(e[4])?12:0;return{hours:n=parseInt(e[1])%12+o,minutes:a=e[3]?parseInt(e[3]):0,seconds:0}}var s;return/\bnow\b/i.test(t)||/next/i.test(t)?{hours:(s=new Date).getHours(),minutes:s.getMinutes(),seconds:0}:null}function i(t,e){var r=s(e);return r&&(t=t||n()).setHours(r.hours,r.minutes,r.seconds),t}var c=class{parseDueDate(t){return function(t){try{return i(o(r(t)||null,t),t)}catch(t){return null}}(t)}parseTime(t){return s(t)}overrideDueDate(t,e,n){return function(t,e,n){if(!r(e)&&!n)return null;let s=t;return s=a(s,n),s=a(s,e),s=o(s,n),s=o(s,e),s=i(s,n),s=i(s,e),s}(t,e,n)}};function u(t,e,n){let r="";for(;e<t.length;e++){if(" "===t[e]){n.push(r),r="",e--;break}if("."===t[e]){n.push(r),r="",e--;break}r+=t[e]}return r&&n.push(r),e}function l(t,e,n,r){let a="";for(;e<t.length;e++){if("."===t[e]){n.push(a),a="",e--;break}if(t[e]===r){n.push(a),a="";break}a+=t[e]}return a&&n.push(a),e}function d(t,e,n){for(;e<t.length&&" "!==t[e];e++)"."!==t[e]&&(e="'"===t[e]||'"'===t[e]?l(t,e+1,n,t[e]):u(t,e,n));return n}function p(t,e,n,r){for(;e<t.length&&t[e]!==r;e++)"."!==t[e]&&(e=l(t,e,n,r));return n}var f=class{parse(t){return function(t){for(var e=[],n=0;n<t.length;n++){if("."===t[n]){d(t,n,e);break}if(("'"===t[n]||'"'===t[n])&&"."===t[n+1]){p(t,n+1,e,t[n]);break}if("'"===t[n]||'"'===t[n])for(var r=t[n++];t[n++]!=r;);}return e}(t)}};var g=class{parse(t){return function(t){var e=t.replace(/^.*?(\/\*\*\s*|$)/,"");try{e+=function(t){var e=[];return t.replace(/((\s|^)(\+1)?[(]*(\d{3})[).\s]*(\d{3})[.\s\-]*(\d{4})(\s|$))/g,(function(t){e.push(function(t){return t.replace(/[^\d]/g,"").replace(/(...)(...)(....)/,"($1) $2-$3")}(t))})),e}(t).map((t=>`\np: ${t}`)).join("")}catch(n){e=t+"\n\n"+n.toString()}return e}(t)}};var m=class{execSync(t,e){const n=[t,...e].map((t=>`'${t}'`)).join(" "),r=Application.currentApplication();r.includeStandardAdditions=!0;const a=r.doShellScript(`${n} 2>&1`),o=r.doShellScript("echo $?"),s=parseInt(o);if(console.log(`doScript: ${n}`),console.log(`stdout: ${a}`),console.log(`exitCode (string): ${o}`),console.log(`exitCode (parsed): ${s}`),0!==s)throw new Error(a.join("\n"));return a}catch(t){throw console.log(`doScript error: ${t}`),t}};const h=new c;function w(t){let e=function(t){const e=/\/(?<pattern>.*)\/(?<flags>[gimy])*$/;if(e.test(t)){const{pattern:n,flags:r}=t.match(e).groups;return new RegExp(n,r)}return new RegExp(t)}(t);return function(t){return!!e.test(t)&&t.match(e)[0]}}function b(t,e){if("string"==typeof t)return t;if("match"in t)return D(t.match,e);if("concatenate"in t)return t.concatenate.map((t=>b(t,e))).join("");if("script"in t){let n=t.script,r=n.args.map((t=>b(t,e)));return(new m).execSync(n.command,r)}return t}function v(t){return t.filter(((e,n)=>t.indexOf(e)==n))}function D(t,e){let n=function(t,e){if("value"in t)return t.value;if("or"in t)return t.or.reduce(((t,n)=>t||D(n,e)),!1);if("and"in t)return t.and.reduce(((t,n)=>t&&D(n,e)),!0);if("not"in t)return!D(t.not,e);if("name"in t)return w(t.name)(e.name);if("project"in t)return w(t.project)(e.contextSpec[0]);if("context"in t)return e.contextSpec.some(w(t.context));if("tag"in t)return function(t,e){return t.tagNames.find((t=>t.toLowerCase()==e.toLowerCase()))}(e,t.tag);if("default-date"in t)return!0;if("default-time"in t)return!0;if("no-project"in t)return t["no-project"]?0==e.contextSpec.length:e.contextSpec.length>0;if("no-parent"in t)return t["no-parent"]?1==e.contextSpec.length:e.contextSpec.length>1;throw new Error("Unknown condition: "+JSON.stringify(t))}(t,e);return console.log(`test: ${JSON.stringify(t)} => ${n}`),n}class y{constructor(t){this.config=t}apply(t){return console.log(`applying rule: ${this.config.name}`),D(this.config.condition,t)&&(console.log(`    rule matched: ${this.config.name}`),this.config.actions.forEach((e=>{console.log(`        action: ${JSON.stringify(e)}`),t=function(t,e){if("tag"in t)e.tagNames.push(t.tag),null==e.primaryTagName&&(e.primaryTagName=t.tag);else if("project"in t){let n=b(t.project,e);e.contextSpec.unshift(n),e.contextSpec=v(e.contextSpec)}else if("parent"in t){let n=b(t.parent,e);e.contextSpec.push(n),e.contextSpec=v(e.contextSpec)}else"due"in t?e.dueDate=h.overrideDueDate(e.dueDate,e.meta,t.due):"remove-tag"in t&&(e.tagNames=e.tagNames.filter((e=>e!=t["remove-tag"])),e.primaryTagName=e.tagNames[0]||null);return e}(e,t)}))),console.log(`result: ${JSON.stringify(t)}`),t}}function k(){ObjC.import("stdlib");return $.getenv("HOME")}function x(t){const e=function(t){try{const e=Application.currentApplication();e.includeStandardAdditions=!0;const n=e.doShellScript(`${t} 2>&1`),r=e.doShellScript("echo $?"),a=parseInt(r);if(console.log(`doScript: ${t}`),console.log(`stdout: ${n}`),console.log(`exitCode (string): ${r}`),console.log(`exitCode (parsed): ${a}`),0!==a)throw new Error(n.join("\n"));return n}catch(t){throw console.log(`doScript error: ${t}`),t}}(`cat "${t=function(t){return t?t=(t=t.replace(/^~/,k())).replace(/^\$HOME/,k()):t}(t)}"`);if(!e)throw new Error(`File not found: ${t}`);return e}var S={description:"Config file for OmniFocus-related quick entry & command-line utilities.",github:"https://github.com/craser/omnifocus",rules:[{name:"All tasks due today by 7pm by default.",condition:{value:!0},actions:[{due:"today 7pm"}]},{name:"Tasks in movies or reading have no default due date.",condition:{or:[{project:"/\\bmovies\\b/i"},{project:"/\\breading\\b/i"}]},actions:[{due:null}]},{name:"Put Jira tickets in .work project",condition:{or:[{project:"/\\b\\w{2,4}-\\d{3,4}\\b/"},{name:"/\\b\\w{2,4}-\\d{3,4}\\b/"}]},actions:[{project:"work"}]},{name:"Put Jira tickets in a ticket-specific parent task",condition:{and:[{name:"/\\b\\w{2,4}-\\d{3,4}\\b/"},{not:{context:"/\\b\\w{2,4}-\\d{3,4}\\b/"}}]},actions:[{parent:{concatenate:[{match:{name:"/\\b\\w{2,4}-\\d{3,4}\\b/"}},": ",{script:{command:"/Users/craser/bin/tickets/tk-get-jira-title",args:[{match:{name:"/\\b\\w{2,4}-\\d{3,4}\\b/"}}]}}]}}]},{name:"Default empty context to work project",condition:{"no-project":!0},actions:[{project:"work"},{parent:"general"}]},{name:"Default work tasks to general parent task",condition:{and:[{project:"/\\bwork\\b/"},{"no-parent":!0}]},actions:[{parent:"general"}]},{name:"Tag expected tasks as :waiting, due at 10pm",condition:{name:"/expect/i"},actions:[{tag:"waiting"},{due:"10pm"}]},{name:":waiting tasks are due at 10pm",condition:{tag:"waiting"},actions:[{due:"10pm"}]},{name:"Work tasks due at 3pm",condition:{and:[{project:"/\\bwork\\b/"}]},actions:[{due:"3pm"}]},{name:"Housekeeping tasks due at 11am",condition:{and:[{project:"/\\bhouse(keeping)?\\b/"},{"default-time":!0}]},actions:[{due:"11am"}]},{name:"Errands due at 11am",condition:{and:[{tag:"errands"}]},actions:[{due:"11am"}]},{name:"Not-due tasks have no due date",condition:{tag:"notdue"},actions:[{due:null},{"remove-tag":"notdue"}]}]};function j(){let t=function(){try{const t=x("$HOME/.ofq-config.json");return JSON.parse(t)}catch(t){return{}}}();return{...S,...t}}class N{constructor(){this.config=j()}getRulesConfig(){return this.config.rules||[]}}class M{constructor(){let t=new N;this.rules=this.parseRules(t.getRulesConfig())}applyRules(t){return this.rules.forEach((e=>{t=e.apply(t)})),t}parseRules(t){return t.map((t=>new y(t)))}}function I(t){return t.replace(/\s*\/\/.*$/,"")}function E(t){return t.replace(/^.*?((\/\/.*?)(\/\*\*.*|$)|$)/,"$2")}function O(t){var e=[];return t.replace(/(\W|^)[#:]([\w\-]+)/g,(function(t,n,r){e.push(r)})),e}function T(t){var e=O(t);return e.length?e[0]:null}function C(t){var e=E(t);return!!/\bflag(ged)?\b/i.test(e)||!!/\bnext\b/i.test(e)}class A{constructor(){this.rulesManager=new M}parse(t){var e=E(t);let n=function(t){var e=E(t);return/\bdone\b/i.test(e)}(t);var r={name:I(t),meta:e,tagNames:O(e),note:(new g).parse(t),dueDate:(new c).parseDueDate(e),flagged:C(t),contextSpec:(new f).parse(e),completed:n,completionDate:n?new Date:null,primaryTagName:T(e)};return r=this.rulesManager.applyRules(r)}}const H="work";function F(t,e){try{var n=t.defaultDocument.flattenedProjects.whose({name:{_beginsWith:e}});return n.length?n[0]():null}catch(t){return console.log(t),null}}function R(t,e,n,r){if(n.length){var a=(o=e,s=n[0],(i=o.tasks.whose({_and:[{name:{_beginsWith:s}},{completed:{_equals:"false"}}]})).length?i[0]:null);a||(a=t.Task({name:n[0]}),e.tasks.push(a)),R(t,a,n.slice(1),r)}else e.tasks.push(r);var o,s,i}function Y(t,e,n){var r=function(t,e){var n=[];console.log(`contextSpec: [${e.map((t=>`'${t}'`)).join(", ")}]`);var r=F(t,e[0]);return r?(e.shift(),n.push(r.name())):(console.log(`no project found for '${e[0]}'`),n.push(H)),n[0]!=H||e.length||n.push("general"),n=n.concat(e),console.log(`context: [${n.map((t=>`'${t}'`)).join(", ")}]`),n}(t,e),a=F(t,r[0]);return a?R(t,a,r.slice(1),n):R(t,a=F(t,H),r,n)}class J{createTask(t){return function(t){var e=Application("OmniFocus"),n=function(t,e){var n=function(t,e){try{return t.defaultDocument.tags.whose({name:{_beginsWith:e}})[0]()}catch(t){return null}}(t,e);return n}(e,t.primaryTagName),r=function(t,e){var n=[];return e.forEach((function(e){var r=t.defaultDocument.tags.whose({name:{_beginsWith:e}}),a=r.length?r()[0]:function(t,e){var n=t.Tag({name:e});return t.defaultDocument.tags.push(n),n}(t,e);n.push(a)})),n}(e,t.tagNames),a=e.Task({name:t.name,primaryTag:t.completed?null:n,dueDate:t.dueDate,note:t.note,completed:t.completed,flagged:t.flagged,completionDate:t.completed?new Date:null});Y(e,t.contextSpec,a),e.add(r,{to:a.tags})}(t)}}function W(t){let e=Math.max(0,t.findIndex((t=>t.endsWith(".js"))));return t.slice(e+1)}const{scriptArgs:_}=function(){ObjC.import("stdlib");const t=$.NSProcessInfo.processInfo.arguments,e=[];for(let n=0;n<t.count;n++){const r=ObjC.unwrap(t.objectAtIndex(n));e.push(r)}return{argv:e,scriptArgs:W(e)}}();try{console.log("################################################################################"),console.log(`creating new task: ${new Date}`),console.log(`input: "${_[0]}"`);var P=_[0],q=(new A).parse(P);(new J).createTask(q),console.log("task created")}catch(t){console.log(`error creating task: ${t}`),console.log(t)}
