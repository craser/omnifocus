#!/Users/craser/.nvm/versions/node/v10.23.0/bin/node

const { exec } = require('child_process');
const TaskParser = require('./js/TaskParser');
const path = require('path');

function getAbsolutePath(cmd) {
    let basename = path.basename(cmd);
    if (basename == cmd) {
        let absolute = path.join(process.cwd(), cmd);
        return absolute;
    } else {
        return cmd;
    }
}

function shell(cmd, f) {
    exec(cmd, function (error, stdout, stderr) {
        console.log(error);
        console.log(stderr.trim());
        f(stdout.trim());
    });
}

function createOmniFocusTask(task) {
    var json = JSON.stringify(task);
    console.log(`json: ${json}`);
    var script = getAbsolutePath('json-to-task.js');
    shell(`${script} '${json}'`, function (text) {
        console.log(text);
    });
}

function run(argv) {
    try {
        console.log('################################################################################');
        console.log(`creating new task: ${new Date()}`);
        console.log(`input: "${argv[0]}"`);
        var string = argv[0];
        var task = new TaskParser().parse(string);
        createOmniFocusTask(task);
        console.log('task created');
    } catch (e) {
        console.log(`error creating task: ${e}`);
        console.log(e);
    }
}

function initEnv(process) {
    let script = process.argv[1];
    let dir = path.dirname(script);
    process.chdir(dir);
}

initEnv(process);
run(process.argv.slice(2));
