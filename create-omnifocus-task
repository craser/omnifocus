#!/usr/bin/ruby

require 'date'
require 'time'

# TODO: Parse "7 days"
def get_due_date(string)
  begin
    string = get_meta(string)
    date = nil
    if (string =~ /tomorrow/i)
      date = Date.today + 1
    else
      date = Date.parse(string) rescue Date.today
    end

    date += (date < Date.today) ? 7 : 0
    time = Time.parse(string) rescue Time.parse("7:00 PM")
    formatted = "#{date.strftime("%m/%d/%Y")} #{time.strftime("%I:%M %p")}"
    return formatted
  rescue
    return "7:00 PM"
  end
end

def get_project(string)
  string = get_meta(string)
  project = /\.(\w+)/.match(string).captures[0] rescue "work"
  return project
end

def get_context(string)
  string = get_meta(string)
  project = /[#](\w+)/.match(string).captures[0] rescue "online"
  return project
end  

def get_meta(string)
  meta = string.gsub(/^.*?(\/\/|$)/, "")
  return meta
end

def get_task_name(string)
  string = string.gsub(/\/\/.*$/, "")
  return string;
end
      
command = ARGV.join(" ")
project = get_project(command)
context = get_context(command)
task_name = get_task_name(command)
due_date = get_due_date(command)
      

puts "project : #{project}"
puts "context : #{context}"
puts "due date: #{due_date}"
puts "task    : #{task_name}"
puts "HOME: "

puts `osascript #{__dir__}/CreateTask.scpt "#{context}" "#{project}" "#{task_name}" "#{due_date}"`

